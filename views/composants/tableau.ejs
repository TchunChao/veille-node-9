<%
    let objOrdre = {
        _id : 'asc',
        nom : 'asc',        
        prenom : 'asc',
        telephone : 'asc',
        courriel : 'asc'
    }
    
    if (typeof cle !== 'undefined'  && cle)
        {
            objOrdre[cle] = ordre
        }
%>


<table class="tableau">
    <tr>
        <th><a href="/trier/_id/<%= objOrdre._id %>">_id<i class="fas fa-<%= (objOrdre._id=='asc'?'sort-up': 'sort-down') %>"></i></a></th>
        <th><a href="/trier/nom/<%= objOrdre.nom %>"><%=__('Nom') %><i class="fas fa-<%= (objOrdre.nom=='asc'?'sort-up': 'sort-down') %>"></i></a></th>
        <th><a href="/trier/prenom/<%= objOrdre.prenom %>"><%=__('Prenom') %><i class="fas fa-<%= (objOrdre.prenom=='asc'?'sort-up': 'sort-down') %>"></i></a></th>        
        <th><a href="/trier/telephone/<%= objOrdre.telephone %>"><%=__('Téléphone') %><i class="fas fa-<%= (objOrdre.telephone=='asc'?'sort-up': 'sort-down') %>"></i></a></th>  
        <th><a href="/trier/courriel/<%= objOrdre.courriel %>"><%=__('Courriel') %><i class="fas fa-<%= (objOrdre.courriel=='asc'?'sort-up': 'sort-down') %>"></i></a></th>      
    </tr>
    
    <%  for (elm of adresses) {%>
    <tr>
        <td><%= elm._id %></td>
        <td contenteditable='true'><%= elm.nom %></td>
        <td contenteditable='true'><%= elm.prenom %></td>
        <td contenteditable='true'><%= elm.telephone %></td>                
        <td contenteditable='true'><%= elm.courriel %></td>    
        <td><a class="detruire" href="#"><i class="fas fa-trash-alt" aria-hidden="true"></i></a></td>
        <td><a class='modifier' href="#"><i class="far fa-save" aria-hidden="true"></i></a></td>
    </tr>
    <% } %>
</table>

<button id='testAJAX'>test AJAX</button>

<button id='ajax_ajouter'>AJOUTER</button>

<script type="text/javascript">
    
    ///////////////////////////////////////////
    
    let elmModifier = document.querySelectorAll('.modifier')
    console.log(elmModifier.length)
    for (elm of elmModifier) {
            elm.addEventListener('click', function() {
                console.log(this.parentElement.parentElement.id)
                let elmTr = this.parentElement.parentElement 
                
                xhr = new XMLHttpRequest();
                xhr.open('POST', "/ajax_modifier", true);
                    
                let _id = elmTr.querySelector('td:nth-child(1)').innerHTML
                let nom = elmTr.querySelector('td:nth-child(2)').innerHTML
                let prenom = elmTr.querySelector('td:nth-child(3)').innerHTML
                let telephone = elmTr.querySelector('td:nth-child(4)').innerHTML
                let courriel = elmTr.querySelector('td:nth-child(5)').innerHTML
                
                data = {
                    "_id" : _id,
                    "nom" : nom,
                    "prenom" : prenom,
                    "telephone" : telephone,
                    "courriel" : courriel
                }
                    
                sData = JSON.stringify(data);
                xhr.setRequestHeader('Content-type', 'application/json');
                xhr.send(sData);
                xhr.addEventListener("readystatechange", traiterRequest, false);   
            })
    }

    let elmDetruire = document.querySelectorAll('.detruire')
    for (elm of elmDetruire) {
            elm.addEventListener('click', function() {
                console.log(this.parentElement.parentElement.id)
                let elmTr = this.parentElement.parentElement 
                
                xhr = new XMLHttpRequest();
                xhr.open('POST', "/ajax_detruire", true);
                    
                let _id = elmTr.querySelector('td:nth-child(1)').innerHTML
                let nom = elmTr.querySelector('td:nth-child(2)').innerHTML
                let prenom = elmTr.querySelector('td:nth-child(3)').innerHTML
                let telephone = elmTr.querySelector('td:nth-child(4)').innerHTML
                let courriel = elmTr.querySelector('td:nth-child(5)').innerHTML
                
                data = {
                    "_id" : _id,
                    "nom" : nom,
                    "prenom" : prenom,
                    "telephone" : telephone,
                    "courriel" : courriel
                }
                    
                sData = JSON.stringify(data);
                xhr.setRequestHeader('Content-type', 'application/json');
                xhr.send(sData);
                xhr.addEventListener("readystatechange", traiterRequest, false);   
            })
        }
        
        function traiterRequest(e){
            console.log("xhr.readyState = " + xhr.readyState)
            console.log("xhr.status = " + xhr.status)

            if(xhr.readyState == 4 && xhr.status == 200){
                console.log('ajax fonctionne')
                var response = JSON.parse(xhr.responseText);
                console.log(response)
                console.log("response._id = " + response._id)
                console.log(xhr.responseText);

                // elmLigne.style.backgroundColor = "#0f0"
            }
        }

        let elmAjouter = document.querySelector('#ajax_ajouter')
        let formulaire = document.querySelector('formulaire')
            
        elmAjouter.addEventListener('click', function() {
            let nom = document.querySelector('#nom')
            let prenom = document.querySelector('#prenom')
            let telephone = document.querySelector('#telephone')
            let courriel = document.querySelector('#courriel')
            console.log(document.querySelector('#nom').value)
            console.log(document.querySelector('#prenom').value)
            console.log(document.querySelector('#telephone').value)
            console.log(document.querySelector('#courriel').value)

            data = {
                "nom" : nom.value,
                "prenom" : prenom.value,
                "telephone" : telephone.value,
                "courriel" : courriel.value
            }

            sData = JSON.stringify(data);
            console.log(sData);
        })

</script>

